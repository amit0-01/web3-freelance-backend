generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id                Int              @id @default(autoincrement())
  name              String
  email             String           @unique
  password          String
  walletAddress     String?          @unique
  role              Role             @default(FREELANCER)
  isGuest           Boolean          @default(false)
  razorpayAccountId String?
  phone             String?
  bio               String?
  githubLink        String?
  skills            String?
  twitterLink       String?
  websiteLink       String?
  avatar            String?
  provider          String?
  providerId        String?          @unique
  applications      Application[]
  receivedMessages  ChatMessage[]    @relation("ReceivedMessages")
  sentMessages      ChatMessage[]    @relation("SentMessages")
  employerJobs      Job[]            @relation("EmployerJobs")
  freelancerJobs    Job[]            @relation("FreelancerJobs")
  chatbotMessages   ChatbotMessage[]
}

model Job {
  id              Int           @id @default(autoincrement())
  title           String
  payment         Decimal       @default(0.0)
  deadline        DateTime?
  isPaid          Boolean       @default(false)
  employerId      Int
  freelancerId    Int?
  category        String[]
  deliverables    String[]
  description     String
  duration        String
  transactionHash String?
  isCompleted     Boolean       @default(false)
  applications    Application[]
  chatMessages    ChatMessage[]
  employer        User          @relation("EmployerJobs", fields: [employerId], references: [id])
  freelancer      User?         @relation("FreelancerJobs", fields: [freelancerId], references: [id])
  payments        Payment[]
}

model Application {
  id                Int               @id @default(autoincrement())
  jobId             Int
  userId            Int
  coverLetter       String
  proposedRate      Float
  estimatedDuration String
  portfolioLink     String?
  createdAt         DateTime          @default(now())
  status            ApplicationStatus @default(PENDING)
  job               Job               @relation(fields: [jobId], references: [id])
  user              User              @relation(fields: [userId], references: [id])
}

model Payment {
  id              String    @id @default(cuid())
  amount          Float
  status          String
  createdAt       DateTime  @default(now())
  completedAt     DateTime?
  transactionHash String?
  type            String
  freelancerId    String
  freelancerName  String
  jobId           Int
  job             Job       @relation(fields: [jobId], references: [id])
   // Gateway-specific fields
  razorpayOrderId    String?  @unique
  razorpayPaymentId  String?
}

model ChatMessage {
  id         String   @id @default(cuid())
  roomId     String
  senderId   Int
  receiverId Int
  content    String
  createdAt  DateTime @default(now())
  jobId      Int?
  job        Job?     @relation(fields: [jobId], references: [id])
  receiver   User     @relation("ReceivedMessages", fields: [receiverId], references: [id])
  sender     User     @relation("SentMessages", fields: [senderId], references: [id])
}

model ChatbotMessage {
  id             Int      @id @default(autoincrement())
  userId         Int
  message        String
  response       String
  conversationId String
  createdAt      DateTime @default(now())
  user           User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([conversationId])
  @@map("chatbot_messages")
}

enum Role {
  FREELANCER
  CLIENT
}

enum ApplicationStatus {
  PENDING
  ACCEPTED
  REJECTED
}
